/**
 * Core Philosophy: This ruleset enforces a 'trusted user' model where any
 * authenticated user is granted full read and write access to the core data
 * collections. This model is designed for internal tools or admin panels where
 * all signed-in users are considered trusted operators (e.g., librarians).
 *
 * Data Structure: The data is organized into several top-level collections
 * representing different aspects of the application: a master book catalog,
 * inventory, sales records, listings, and application settings. There are no
 * user-specific subcollections, promoting a simple, flat hierarchy suitable
 * for centralized data management.
 *
 * Key Security Decisions:
 * - Uniform Access: The primary security decision is to grant consistent access
 *   to all authenticated users, simplifying the ruleset significantly.
 * - Default Deny: All access is denied by default. Unauthenticated users have
 *   no access to any data.
 * - No Schema Validation: In this prototyping phase, data shapes are not
 *   enforced, allowing for rapid iteration on the client-side. The focus is
 *   strictly on authorization.
 *
 * Denormalization for Authorization: This model does not require denormalization
 * for authorization because access is not dependent on relationships between
 * documents (e.g., document ownership or team membership). Access is granted
 * globally to all signed-in users, which eliminates the need for extra
 * document reads (`get()`) in rules.
 *
 * Structural Segregation: This pattern is not applicable in this model, as
 * there is no distinction between public and private data. All data is treated
 * as internal to the system and accessible only by authenticated operators.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the user is the owner of the document.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description
     *   Manages the master catalog of books. Any authenticated user can read,
     *   create, update, and delete book records.
     * @path
     *   /books/{bookId}
     * @allow
     *   An authenticated user (e.g., a librarian) can create a new book entry.
     *   (auth: { uid: 'librarian_abc' }, op: create)
     * @deny
     *   An unauthenticated (anonymous) user cannot list the books.
     *   (auth: null, op: list)
     * @principle
     *   Grants full access to any authenticated user, treating them as a
     *   trusted operator of the system.
     */
    match /books/{bookId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description
     *   Manages inventory items. Any authenticated user can read and modify
     *   the inventory data.
     * @path
     *   /inventory_items/{inventoryItemId}
     * @allow
     *   An authenticated user can update the quantity of an existing inventory item.
     *   (auth: { uid: 'librarian_abc' }, op: update)
     * @deny
     *   An anonymous user cannot create a new inventory item.
     *   (auth: null, op: create)
     * @principle
     *   Grants full access to any authenticated user, treating them as a
     *   trusted operator of the system.
     */
    match /inventory_items/{inventoryItemId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description
     *   Manages sales records. All authenticated users can read and write sales
     *   data, assuming they are trusted employees.
     * @path
     *   /sales/{saleId}
     * @allow
     *   An authenticated user can create a new sales record.
     *   (auth: { uid: 'clerk_xyz' }, op: create)
     * @deny
     *   An anonymous user cannot view any sales records.
     *   (auth: null, op: get)
     * @principle
     *   Grants full access to any authenticated user, treating them as a
     *   trusted operator of the system.
     */
    match /sales/{saleId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description
     *   Manages product listings. Authenticated users are permitted to create,
     *   view, and manage all listings.
     * @path
     *   /listings/{listingId}
     * @allow
     *   An authenticated user can delete an old product listing.
     *   (auth: { uid: 'manager_123' }, op: delete)
     * @deny
     *   An anonymous user cannot list any product listings.
     *   (auth: null, op: list)
     * @principle
     *   Grants full access to any authenticated user, treating them as a
     *   trusted operator of the system.
     */
    match /listings/{listingId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description
     *   Manages application-wide settings. Access is restricted to authenticated
     *   users, who can read and modify all settings.
     * @path
     *   /settings/{settingId}
     * @allow
     *   An authenticated user can update a system setting.
     *   (auth: { uid: 'admin_abc' }, op: update)
     * @deny
     *   An anonymous user cannot read any settings.
     *   (auth: null, op: get)
     * @principle
     *   Grants full access to any authenticated user, treating them as a
     *   trusted operator of the system.
     */
    match /settings/{settingId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Manages user profiles.
     * @path /users/{userId}
     * @allow An authenticated user can read and write to their own profile.
     * @deny An authenticated user cannot access another user's profile.
     * @principle Path-based ownership: Access is granted if the user's UID
     *   matches the document ID in the path.
     */
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }
  }
}